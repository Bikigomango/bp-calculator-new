name: CI/CD Pipeline for Blood Pressure Calculator

on:
  push:
    branches:
      - "main"           # Production branch
      - "develop"        # Development branch
      - "feature/*"      # Feature branches
  pull_request:
    branches:
      - "main"           # Require PR reviews for main
      - "develop"        # Automatically test PRs to develop

# =====================
# ENVIRONMENT VARIABLES
# =====================
env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_FILE: './bp-calculator.sln'
  TEST_PROJECT: './BP.Tests/BP.Tests.csproj'
  COVERAGE_THRESHOLD: 80

# =====================
# CI PIPELINE STAGES
# =====================
jobs:
  # STAGE 1: CODE QUALITY & VALIDATION
  validate:
    name: "üîç Code Validation & Quality"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get all history for SonarCloud

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Validate Project Structure
        run: |
          echo "üîß Validating project structure..."
          dotnet sln list ${{ env.SOLUTION_FILE }}
          dotnet --info

      - name: Code Style Analysis
        run: |
          echo "üé® Checking code style..."
          dotnet format ${{ env.SOLUTION_FILE }} --verify-no-changes --verbosity detailed

      - name: NuGet Security Audit
        run: |
          echo "üõ°Ô∏è Scanning for vulnerable packages..."
          dotnet list package --vulnerable --include-transitive
          dotnet outdated  # Check for outdated packages

  # STAGE 2: BUILD & COMPILATION
  build:
    name: "üèóÔ∏è Build & Compilation"
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: |
          echo "üì¶ Restoring dependencies..."
          dotnet restore ${{ env.SOLUTION_FILE }} --verbosity detailed

      - name: Build Solution
        run: |
          echo "üî® Building solution..."
          dotnet build ${{ env.SOLUTION_FILE }} \
            --configuration Release \
            --no-restore \
            --verbosity detailed

      - name: Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/bin/Release/net9.0/**
            **/publish/
          retention-days: 7

  # STAGE 3: TESTING & CODE COVERAGE
  test:
    name: "üß™ Testing & Coverage"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run Unit Tests
        run: |
          echo "üß™ Running unit tests..."
          dotnet test ${{ env.TEST_PROJECT }} \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --logger "trx;LogFileName=test-results.trx" \
            --verbosity normal

      - name: Generate Test Reports
        run: |
          echo "üìä Generating test reports..."
          # Install report generator
          dotnet tool install --global dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:**/coverage.cobertura.xml \
            -targetdir:./TestResults/CoverageReport \
            -reporttypes:HtmlInline_AzurePipelines;Cobertura

      - name: Verify Code Coverage
        run: |
          echo "üìà Checking code coverage..."
          # Extract coverage percentage
          COVERAGE=$(grep -oP 'line-rate="\K[0-9.]+' **/coverage.cobertura.xml | head -1)
          COVERAGE_PERCENT=$(echo "$COVERAGE * 100" | bc -l | xargs printf "%.2f")
          
          echo "Code Coverage: $COVERAGE_PERCENT%"
          
          if (( $(echo "$COVERAGE_PERCENT >= ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
            echo "‚úÖ Code coverage PASSED (‚â• ${{ env.COVERAGE_THRESHOLD }}%)"
          else
            echo "‚ùå Code coverage FAILED: $COVERAGE_PERCENT% (< ${{ env.COVERAGE_THRESHOLD }}%)"
            exit 1
          fi

      - name: Run BDD Tests (SpecFlow)
        run: |
          echo "üìù Running BDD tests..."
          # If you have SpecFlow tests
          # dotnet test ./BDD.Tests/BDD.Tests.csproj --configuration Release
          echo "BDD tests placeholder - Implement with SpecFlow"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/TestResults/**/*.trx
            **/TestResults/CoverageReport/
            **/coverage.cobertura.xml
          retention-days: 30

  # STAGE 4: STATIC ANALYSIS & SECURITY
  analyze:
    name: "üî¨ Static Analysis & Security"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: SonarCloud Quality Gate
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.projectKey=bp-calculator-${{ github.ref_name }}
            -Dsonar.projectName="BP Calculator - ${{ github.ref_name }}"
            -Dsonar.sources=.
            -Dsonar.cs.opencover.reportsPaths=**/coverage.opencover.xml
            -Dsonar.coverage.exclusions=**/Tests/**,**/*Test.cs
            -Dsonar.cpd.exclusions=**/Migrations/**
            -Dsonar.branch.name=${{ github.ref_name }}

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          project: 'bp-calculator'
          path: '.'
          format: 'HTML'
          args: >
            --enableExperimental
            --failOnCVSS 7

      - name: Secret Scanning
        run: |
          echo "üîë Scanning for exposed secrets..."
          # Using gitleaks for secret scanning
          docker run -v $(pwd):/src zricethezav/gitleaks:latest detect --source="/src" --verbose

  # STAGE 5: DOCKER IMAGE BUILD
  dockerize:
    name: "üê≥ Docker Image Build"
    runs-on: ubuntu-latest
    needs: analyze
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # STAGE 6: DEPLOYMENT (Conditional)
  deploy-qa:
    name: "üöÄ Deploy to QA"
    runs-on: ubuntu-latest
    needs: dockerize
    if: github.ref == 'refs/heads/develop'
    environment: qa
    
    steps:
      - name: Deploy to QA Environment
        run: |
          echo "Deploying to QA environment..."
          # Add your QA deployment logic here
          echo "Deployment placeholder"

# =====================
# WORKFLOW VISUALIZATION
# =====================
# Pipeline Flow:
# validate ‚Üí build ‚Üí test ‚Üí analyze ‚Üí dockerize ‚Üí deploy-qa (if develop branch)
# validate ‚Üí build ‚Üí test ‚Üí analyze ‚Üí dockerize (if main branch)